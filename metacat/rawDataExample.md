# Raw data example of metacat

## A minimal example for raw data

To store data you need to provide at least minimal metadata.

Here is an annotated example of finding and listing the metadata for recent coldbox data using metacat.  Any new raw data needs to supply similar information in hdf5 format.

## how do set up metacat and find example files:

First `setup metacat` (it's in cvmfs and accessible via ups like other DUNE packages).

See https://metacat.readthedocs.io/en/latest/ for full documentation in metacat.  In particular how to authenticate.  

You can do

```metacat auth login $USER```

to use your services password, but `kx509` authentication is also available.

```metacat query "files from dune:all where core.file_type=detector and core.run_type='hd-coldbox' and core.data_tier='raw'"```

here `dune:all` is a dataset that contains all of the info we found in the sam system.

## metadata for an example raw data file

the `checksums` and `fid` are generated by the system but you need to provide the rest.

```metacat file show -m default:np04_coldbox_run012270_0001_20211209T111918.hdf5 ```
makes an easily readable example but `--json` may be more useful. The `-m` gives you the full metadata.

```metacat file show -m --json default:np04_coldbox_run012270_0001_20211209T111918.hdf5 ```
```json
{
    "checksums": {
        "adler32": "b457345a"
    },
    "created_timestamp": 1639049407.36323,
    "creator": "timm",
    "fid": "61688903",
    "name": "np04_coldbox_run012270_0001_20211209T111918.hdf5",
    "namespace": "default",
    "size": 3079531200,
    "metadata": {
        "core.data_stream": "test",
        "core.data_tier": "raw",
        "core.event_count": 81,
        "core.events": [
            113,
            114,
            ...
        ],
        "core.file_content_status": "good",
        "core.file_format": "hdf5",
        "core.file_type": "detector",
        "core.first_event_number": 113,
        "core.last_event_number": 193,
        "core.run_type": "hd-coldbox",
        "core.runs": [
            12270
        ],
        "core.runs_subruns": [
            1227000001
        ]
    }
}
```

### Basics for ny file

First a list of the items any file needs to have in order to be stored.

| item | description | comment |
|---------------------|------------------|--------------
| checksums | checksum for file | generated for you |
| created_timestamp | time file was created | stored as unix time |
|creator           |	timm | userid of person who created it|
|fid          | file id #       | generated for you|
|name                | file name | must be unique within |namespace | 	metacat file namespace | |
|size                | File size in bytes | |
| metadata | more data about the file | see below|

### Contents of the metadata part of metacat

metadata contents:

metacat also allows you to add additional information.

metadata have an X.Y structure. The major ones that used to be in sam are in core but one can have others.

Most of the fields below are required for DUNE to use the data. The non-optional ones are listed below.  The first and last event are, however, not that useful, especially if you store the event list.

`core.start_time`:
    time data taking started.  
`core.end_time`:
    time data taking ended.  You need these to match the data up with the runs and calibration databases.  
`core.data_stream`:
 tells you what kind of trigger it is.  
`core.data tier`:
 tells you what level of processing.  
`core.file_content_status`:
 marks damaged files.  
`core.file_format`:
  allows you to figure out how to decode the file.   
`core.run_type`:
    tells you what experiment (daq) produced the file
`core.runs`:
    is a list of run numbers, useful once you start merging data.  
`core.runs_subruns`:
    is a list of run/subruns in run*100000+subrun format.  
`core.event_count`:
    is the number of events in the file

`run_type`, `data_tier`, `data_stream` and `runs` determine how data are placed on tape and moved on and off disk.


| item | what it is | example values|
| ----------| ----------- | --------- |
|core.start_time | time data taking started | UTC time|
|core.end_time | time data taking ended | UTC time|
|core.data_stream    | data stream  | [physics,test] |
|    core.data_tier  |  data tier  | [raw,full-reconstructed ...] |
| core.event_count    | # of events in file | 128 |
|    core.file_content_status |    | good|
|    core.file_format    |   | [hdf5, binary, root, artroot ...] |
|    core.file_type      | mc vs data | [mc, detector]  |
|    core.run_type       | run type| [protodune-sp, hd-coldbox ...] |
|    core.runs           | [list of runs]   | [1,2] |
|    core.runs_subruns   | [list of subruns] | in run*100000 + subrun format|
|    core.events      | optional | [1,2,3] |
|    core.first_event_number| optional | 1|
|    core.last_event_number|  optional | 3 |

## More information

one can (should) also include information about provenance - for example the DAQ version used and the time range

```metacat file show -m pdsp_det_reco:np04_raw_run005141_0015_dl6_reco1_18126068_0_20210318T101703Z.root --json```

gives you


```json
{
    "checksums": {
        "adler32": "bcbce740",
        "enstore": "1185343295",
        "md5": "af8f009716151e209792d1445fe528cb"
    },
    "created_timestamp": 1616174526.59504,
    "creator": "dunepro",
    "fid": "52500975",
    "name": "np04_raw_run005141_0015_dl6_reco1_18126068_0_20210318T101703Z.root",
    "namespace": "pdsp_det_reco",
    "size": 4033240906,
    "metadata": {
        "DUNE.campaign": "PDSPProd4",
        "DUNE_data.DAQConfigName": "np04_WibsReal_Ssps_BeamTrig_00021",
        "DUNE_data.acCouple": 0,
        "DUNE_data.calibpulsemode": 0,
        "DUNE_data.detector_config": "..."
        "DUNE_data.detector_config.object": [...],
        "DUNE_data.febaselineHigh": 2,
        "DUNE_data.fegain": 2,
        "DUNE_data.feleak10x": 0,
        "DUNE_data.feleakHigh": 1,
        "DUNE_data.feshapingtime": 2,
        "DUNE_data.inconsistent_hw_config": 0,
        "DUNE_data.is_fake_data": 0,
        "art.file_format_era": "ART_2011a",
        "art.file_format_version": 13,
        "art.first_event": 20967,
        "art.last_event": 22474,
        "art.process_name": "Reco1",
        "art.run_type": "protodune-sp",
        "beam.momentum": 7,
        "core.application": "art.reco",
        "core.application.family": "art",
        "core.application.name": "reco",
        "core.application.version": "v09_09_01",
        "core.data_stream": "physics",
        "core.data_tier": "full-reconstructed",
        "core.end_time": 1616173579,
        "core.event_count": 108,
        "core.file_content_status": "good",
        "core.file_format": "artroot",
        "core.file_type": "detector",
        "core.first_event_number": 20967,
        "core.last_event_number": 22474,
        "core.run_type": "protodune-sp",
        "core.runs": [5141],
        "core.runs_subruns": [514100001],
        "core.start_time": 1616063547,
        "data_quality.online_good_run_list": 1,
        "detector.hv_value": 180
    }
}
```
